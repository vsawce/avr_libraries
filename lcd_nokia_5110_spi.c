#include "lcd_nokia_5110_spi.h"

/* DC & CS Toggle Macros, pins defined in conf.h */
#define NOKIA_DC_HIGH PORTD |= (1<<DC)
#define NOKIA_DC_LOW PORTD &= ~(1<<DC)
#define NOKIA_CS_HIGH PORTB |= (1<<CS)
#define NOKIA_CS_LOW PORTB &= ~(1<<CS)
#define NOKIA_RST_HIGH PORTD |= (1<<RST);
#define NOKIA_RST_LOW PORTD &= ~(1<<RST);

/* Nokia 5110 Defines */
#define NOKIA_WIDTH 84
#define NOKIA_HEIGHT 48
#define NOKIA_BYTE_SIZE 504 //NOKIA_WIDTH*NOKIA_HEIGHT/8

static const uint8_t ASCII[][5] PROGMEM = {
	// First 32 characters (0x00-0x19) are ignored. These are
	// non-displayable, control characters.
	{0x00, 0x00, 0x00, 0x00, 0x00} // 0x20
	,{0x00, 0x00, 0x5f, 0x00, 0x00} // 0x21 !
	,{0x00, 0x07, 0x00, 0x07, 0x00} // 0x22 "
	,{0x14, 0x7f, 0x14, 0x7f, 0x14} // 0x23 #
	,{0x24, 0x2a, 0x7f, 0x2a, 0x12} // 0x24 $
	,{0x23, 0x13, 0x08, 0x64, 0x62} // 0x25 %
	,{0x36, 0x49, 0x55, 0x22, 0x50} // 0x26 &
	,{0x00, 0x05, 0x03, 0x00, 0x00} // 0x27 '
	,{0x00, 0x1c, 0x22, 0x41, 0x00} // 0x28 (
	,{0x00, 0x41, 0x22, 0x1c, 0x00} // 0x29 )
	,{0x14, 0x08, 0x3e, 0x08, 0x14} // 0x2a *
	,{0x08, 0x08, 0x3e, 0x08, 0x08} // 0x2b +
	,{0x00, 0x50, 0x30, 0x00, 0x00} // 0x2c ,
	,{0x08, 0x08, 0x08, 0x08, 0x08} // 0x2d -
	,{0x00, 0x60, 0x60, 0x00, 0x00} // 0x2e .
	,{0x20, 0x10, 0x08, 0x04, 0x02} // 0x2f /
	,{0x3e, 0x51, 0x49, 0x45, 0x3e} // 0x30 0
	,{0x00, 0x42, 0x7f, 0x40, 0x00} // 0x31 1
	,{0x42, 0x61, 0x51, 0x49, 0x46} // 0x32 2
	,{0x21, 0x41, 0x45, 0x4b, 0x31} // 0x33 3
	,{0x18, 0x14, 0x12, 0x7f, 0x10} // 0x34 4
	,{0x27, 0x45, 0x45, 0x45, 0x39} // 0x35 5
	,{0x3c, 0x4a, 0x49, 0x49, 0x30} // 0x36 6
	,{0x01, 0x71, 0x09, 0x05, 0x03} // 0x37 7
	,{0x36, 0x49, 0x49, 0x49, 0x36} // 0x38 8
	,{0x06, 0x49, 0x49, 0x29, 0x1e} // 0x39 9
	,{0x00, 0x36, 0x36, 0x00, 0x00} // 0x3a :
	,{0x00, 0x56, 0x36, 0x00, 0x00} // 0x3b ;
	,{0x08, 0x14, 0x22, 0x41, 0x00} // 0x3c <
	,{0x14, 0x14, 0x14, 0x14, 0x14} // 0x3d =
	,{0x00, 0x41, 0x22, 0x14, 0x08} // 0x3e >
	,{0x02, 0x01, 0x51, 0x09, 0x06} // 0x3f ?
	,{0x32, 0x49, 0x79, 0x41, 0x3e} // 0x40 @
	,{0x7e, 0x11, 0x11, 0x11, 0x7e} // 0x41 A
	,{0x7f, 0x49, 0x49, 0x49, 0x36} // 0x42 B
	,{0x3e, 0x41, 0x41, 0x41, 0x22} // 0x43 C
	,{0x7f, 0x41, 0x41, 0x22, 0x1c} // 0x44 D
	,{0x7f, 0x49, 0x49, 0x49, 0x41} // 0x45 E
	,{0x7f, 0x09, 0x09, 0x09, 0x01} // 0x46 F
	,{0x3e, 0x41, 0x49, 0x49, 0x7a} // 0x47 G
	,{0x7f, 0x08, 0x08, 0x08, 0x7f} // 0x48 H
	,{0x00, 0x41, 0x7f, 0x41, 0x00} // 0x49 I
	,{0x20, 0x40, 0x41, 0x3f, 0x01} // 0x4a J
	,{0x7f, 0x08, 0x14, 0x22, 0x41} // 0x4b K
	,{0x7f, 0x40, 0x40, 0x40, 0x40} // 0x4c L
	,{0x7f, 0x02, 0x0c, 0x02, 0x7f} // 0x4d M
	,{0x7f, 0x04, 0x08, 0x10, 0x7f} // 0x4e N
	,{0x3e, 0x41, 0x41, 0x41, 0x3e} // 0x4f O
	,{0x7f, 0x09, 0x09, 0x09, 0x06} // 0x50 P
	,{0x3e, 0x41, 0x51, 0x21, 0x5e} // 0x51 Q
	,{0x7f, 0x09, 0x19, 0x29, 0x46} // 0x52 R
	,{0x46, 0x49, 0x49, 0x49, 0x31} // 0x53 S
	,{0x01, 0x01, 0x7f, 0x01, 0x01} // 0x54 T
	,{0x3f, 0x40, 0x40, 0x40, 0x3f} // 0x55 U
	,{0x1f, 0x20, 0x40, 0x20, 0x1f} // 0x56 V
	,{0x3f, 0x40, 0x38, 0x40, 0x3f} // 0x57 W
	,{0x63, 0x14, 0x08, 0x14, 0x63} // 0x58 X
	,{0x07, 0x08, 0x70, 0x08, 0x07} // 0x59 Y
	,{0x61, 0x51, 0x49, 0x45, 0x43} // 0x5a Z
	,{0x00, 0x7f, 0x41, 0x41, 0x00} // 0x5b [
	,{0x02, 0x04, 0x08, 0x10, 0x20} // 0x5c \ (keep this to escape the backslash)
	,{0x00, 0x41, 0x41, 0x7f, 0x00} // 0x5d ]
	,{0x04, 0x02, 0x01, 0x02, 0x04} // 0x5e ^
	,{0x40, 0x40, 0x40, 0x40, 0x40} // 0x5f _
	,{0x00, 0x01, 0x02, 0x04, 0x00} // 0x60 `
	,{0x20, 0x54, 0x54, 0x54, 0x78} // 0x61 a
	,{0x7f, 0x48, 0x44, 0x44, 0x38} // 0x62 b
	,{0x38, 0x44, 0x44, 0x44, 0x20} // 0x63 c
	,{0x38, 0x44, 0x44, 0x48, 0x7f} // 0x64 d
	,{0x38, 0x54, 0x54, 0x54, 0x18} // 0x65 e
	,{0x08, 0x7e, 0x09, 0x01, 0x02} // 0x66 f
	,{0x0c, 0x52, 0x52, 0x52, 0x3e} // 0x67 g
	,{0x7f, 0x08, 0x04, 0x04, 0x78} // 0x68 h
	,{0x00, 0x44, 0x7d, 0x40, 0x00} // 0x69 i
	,{0x20, 0x40, 0x44, 0x3d, 0x00} // 0x6a j
	,{0x7f, 0x10, 0x28, 0x44, 0x00} // 0x6b k
	,{0x00, 0x41, 0x7f, 0x40, 0x00} // 0x6c l
	,{0x7c, 0x04, 0x18, 0x04, 0x78} // 0x6d m
	,{0x7c, 0x08, 0x04, 0x04, 0x78} // 0x6e n
	,{0x38, 0x44, 0x44, 0x44, 0x38} // 0x6f o
	,{0x7c, 0x14, 0x14, 0x14, 0x08} // 0x70 p
	,{0x08, 0x14, 0x14, 0x18, 0x7c} // 0x71 q
	,{0x7c, 0x08, 0x04, 0x04, 0x08} // 0x72 r
	,{0x48, 0x54, 0x54, 0x54, 0x20} // 0x73 s
	,{0x04, 0x3f, 0x44, 0x40, 0x20} // 0x74 t
	,{0x3c, 0x40, 0x40, 0x20, 0x7c} // 0x75 u
	,{0x1c, 0x20, 0x40, 0x20, 0x1c} // 0x76 v
	,{0x3c, 0x40, 0x30, 0x40, 0x3c} // 0x77 w
	,{0x44, 0x28, 0x10, 0x28, 0x44} // 0x78 x
	,{0x0c, 0x50, 0x50, 0x50, 0x3c} // 0x79 y
	,{0x44, 0x64, 0x54, 0x4c, 0x44} // 0x7a z
	,{0x00, 0x08, 0x36, 0x41, 0x00} // 0x7b {
	,{0x00, 0x00, 0x7f, 0x00, 0x00} // 0x7c |
	,{0x00, 0x41, 0x36, 0x08, 0x00} // 0x7d }
	,{0x10, 0x08, 0x08, 0x10, 0x08} // 0x7e ~
	,{0x78, 0x46, 0x41, 0x46, 0x78} // 0x7f DEL
};

uint8_t display_map[NOKIA_BYTE_SIZE] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,0)->(11,7) ~ These 12 bytes cover an 8x12 block in the left corner of the display
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,0)->(23,7)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, // (24,0)->(35,7)
	0xF0, 0xF8, 0xFC, 0xFC, 0xFE, 0xFE, 0xFE, 0xFE, 0x1E, 0x0E, 0x02, 0x00, // (36,0)->(47,7)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (48,0)->(59,7)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,0)->(71,7)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,0)->(83,7)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,8)->(11,15)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,8)->(23,15)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, // (24,8)->(35,15)
	0x0F, 0x1F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xF8, // (36,8)->(47,15)
	0xF8, 0xF0, 0xF8, 0xFE, 0xFE, 0xFC, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00, // (48,8)->(59,15)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,8)->(71,15)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,8)->(83,15)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,16)->(11,23)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,16)->(23,23)
	0x00, 0x00, 0xF8, 0xFC, 0xFE, 0xFE, 0xFF, 0xFF, 0xF3, 0xE0, 0xE0, 0xC0, // (24,16)->(35,23)
	0xC0, 0xC0, 0xE0, 0xE0, 0xF1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // (36,16)->(47,23)
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3E, 0x00, 0x00, 0x00, // (48,16)->(59,23)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,16)->(71,23)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,16)->(83,23)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,24)->(11,31)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,24)->(23,31)
	0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // (24,24)->(35,31)
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // (36,24)->(47,31)
	0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, // (48,24)->(59,31)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,24)->(71,31)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,24)->(83,31)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,32)->(11,39)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,32)->(23,39)
	0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, // (24,32)->(35,39)
	0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, // (36,32)->(47,39)
	0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (48,32)->(59,39)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,32)->(71,39)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,32)->(83,39)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (0,40)->(11,47)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (12,40)->(23,47)
	0x00, 0x00, 0x3F, 0x1F, 0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, // (24,40)->(35,47)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (36,40)->(47,47)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (48,40)->(59,47)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (60,40)->(71,47)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (72,40)->(83,47) !!! The bottom right pixel!
};

extern uint8_t scale = 1; //1 is default. Only in integer increments

void nokia__cmd(uint8_t cmd) {
	 NOKIA_DC_LOW;		//LOW DC pin denotes command mode
	 NOKIA_CS_LOW;		//Selects 5110 by setting CS to LOW
	 spi__write(cmd);	//Sends a byte via SPI to the LCD
	 NOKIA_CS_HIGH;		//De-selects 5110 by setting CS to HIGH
}

void nokia__data(uint8_t data) {
	NOKIA_DC_HIGH;		//HIGH DC pin denotes data mode
	NOKIA_CS_LOW;		//Selects 5110 by setting CS to LOW
	spi__write(data);	//Sends a byte via SPI to the LCD
	NOKIA_CS_HIGH;		//De-selects 5110 by setting CS to HIGH
}

void nokia__init() {
	DDRD = (1<<DC) | (1<<RST);	//Sets DC as output
	NOKIA_RST_HIGH;
	NOKIA_CS_HIGH;				//Sets CS pin to HIGH so when cmd or data are utilized, CS goes from HIGH to LOW
	_delay_ms(10);
	NOKIA_RST_LOW;
	_delay_ms(70);
	NOKIA_RST_HIGH;
	
	NOKIA_CS_LOW;
	nokia__cmd(0b00100001);		//Func. set: PD = 0 -> active chip, V = 0 -> horiz. addressing, H = 1 -> ext. instruct. set (Page 14 of Datasheet)
	nokia__cmd(0b00000110);		//Temp. ctrl: TC1 = 1, TC0 = 0 -> V_LCD temp. coeff 2 (Page 14 of Datasheet)
	nokia__cmd(0b00010011);		//LCD Bias: BS2 = 0, BS1 = 1, BS0 = 1 -> Bias of 1:48 (Page 14 & 15 of Datasheet)
	nokia__cmd(0b11000010);		//Set VOP: Contrast, VO6-VO0 = 48 implies operating voltage of 3.06v
	nokia__cmd(0b00100000);		//Func. set: PD = 0 -> active chip, V = 0 -> horiz. addressing, H = 0 -> basic instruct. set (Page 14 of Datasheet)
	nokia__cmd(0b00001001);		//Display ctrl: D = 1, E = 0 -> Normal mode
	
	nokia__cmd(0x80);
	nokia__cmd(0x40);
	nokia__wipe();
	
	/* Activate LCD */
	nokia__cmd(0x08);
	nokia__cmd(0x0C);
}

void nokia__cursor(uint8_t x, uint8_t y) {
	nokia__cmd(x);
	nokia__cmd(y);
}

void nokia__cursor_origin() {
	nokia__cursor(0,0);
}

void nokia__update() {
	nokia__cursor_origin();
	for (uint16_t i = 0; i < NOKIA_BYTE_SIZE; ++i) {
		nokia__data(display_map[i]);
	}
}

void nokia__wipe() {
	for (uint16_t i = 0; i < NOKIA_BYTE_SIZE; ++i) {
		display_map[i] = 0;
	}
}

void nokia__fill() {
	for (uint16_t i = 0; i < NOKIA_BYTE_SIZE; ++i) {
		display_map[i] = 0xFF;
	}
}

void nokia__pixel(uint8_t x, uint8_t y, uint8_t whtblk) {
	uint8_t y_shift = y % 8;
	if (x < NOKIA_WIDTH) {
		if (y < NOKIA_HEIGHT) {
			if (whtblk) {		//1 -> black pixel
				display_map[x + (y/8)*NOKIA_WIDTH] |= (1 << y_shift);
			}
			else {				//0 -> white/empty pixel
				display_map[x + (y/8)*NOKIA_WIDTH] &= ~(1 << y_shift);
			}
		}
	}
}

void nokia__scale(uint8_t sc) {
	scale = sc;
}


void nokia__char(char c, uint8_t x, uint8_t y) {
	//char col;
	for (uint8_t i = 0; i < 5*scale; ++i) {
		//col = ASCII[c - 0x20][i];
		for (uint8_t j = 0; j < 8*scale; ++j) {
			if (pgm_read_byte(&ASCII[c - 0x20][i/scale]) & (0x01 << j/scale)) {
				nokia__pixel(x + i, y + j, BLACK);
			}
			else {
				nokia__pixel(x + i, y + j, WHITE);
			}
		}
	}
}

void nokia__str(char str[], uint8_t str_size, uint8_t x, uint8_t y) {
	for (int i = 0; i < str_size; ++i) {
		nokia__char(str[i], x, y);
		x += 5*scale + 1;
	}
}